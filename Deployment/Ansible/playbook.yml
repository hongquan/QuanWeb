---
- name: Deploy Quan personal website
  hosts: all
  # This is needed to make ansible_env work
  gather_facts: true
  gather_subset:
    - "!all"
  vars:
    base_folder: /home/{{ ansible_user }}/QuanWeb/quanweb/
    ladmin_folder: "{{ base_folder }}ladmin"
    source_folder: '{{ playbook_dir | dirname | dirname }}'
    ladmin_built_source: '{{ source_folder }}/ladmin-built/'

  tasks:
    - name: Clean source  # noqa command-instead-of-module
      ansible.builtin.command: git reset --hard
      args:
        chdir: "{{ base_folder }}"
      register: git_reset
      changed_when: git_reset.rc == 0

    - name: Update source
      ansible.builtin.git:
        repo: "git@bitbucket.org:hongquan/quanweb.git"
        dest: "{{ base_folder }}"
        version: "main"
      register: git_out

    - name: Sync built ladmin app
      ansible.posix.synchronize:
        src: '{{ ladmin_built_source }}'
        dest: '{{ ladmin_folder }}/dist'
        delete: true
      when: ladmin_built_source is exists

    - name: Debug git_out
      ansible.builtin.debug:
        var: git_out

  environment:
    # Modify PATH so that bun can be found.
    PATH: "{{ base_folder }}/venv/bin:{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.HOME }}/.bun/bin"
